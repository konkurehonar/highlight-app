 Architecture.md

# پشته فنی و معماری پروژه کوشک کنکورهنر

این مستند معماری فنی و زیرساخت پروژه کوشک کنکورهنر را توصیف می‌کند. پروژه از یک معماری توزیع‌شده استفاده می‌کند که در آن بخش‌های مختلف روی پلتفرم‌های متفاوت میزبانی می‌شوند.

## نمای کلی معماری

پروژه کوشک کنکورهنر از یک معماری چندلایه استفاده می‌کند:

1. **لایه فرانت‌اند**: توسعه‌یافته با Next.js و میزبانی شده روی Vercel
2. **لایه بک‌اند**: توسعه‌یافته با Rust و میزبانی شده روی VPS (ParsPack)
3. **لایه دیتابیس**: مبتنی بر Supabase
4. **لایه مدیریت محتوا**: AppFlowy برای تولید و مدیریت محتوا
5. **لایه هوش مصنوعی**: سیستم RAG با استفاده از OpenAI API

## زیرساخت سرور

### الف. نصب و پیکربندی پایه سرور

#### سیستم‌عامل و امنیت
- نصب Ubuntu 22.04 LTS به عنوان سیستم‌عامل پایه
- پیکربندی UFW (Uncomplicated Firewall) برای مدیریت دسترسی‌ها
- نصب و پیکربندی Fail2Ban برای محافظت در برابر حملات brute-force
- تنظیم SSH با کلید و غیرفعال‌سازی ورود با رمز عبور

#### زیرساخت برنامه‌نویسی
- نصب Rust و ابزارهای مرتبط (cargo, rustup)
- نصب Redis Server برای مدیریت کش و جلسات
- نصب و پیکربندی Nginx یا Caddy برای پراکسی معکوس و ریدایرکت‌ها
- نصب Docker برای کانتینرایز کردن سرویس‌ها (اختیاری)

### ب. استقرار سرویس بک‌اند

#### راه‌اندازی API
- کامپایل و استقرار برنامه Rust API روی VPS
- تنظیم systemd برای اجرای دائم سرور Rust و راه‌اندازی خودکار
- مدیریت متغیرهای محیطی برای اتصال به Supabase و سایر سرویس‌ها

#### مسیریابی و پراکسی
- تنظیم Nginx/Caddy برای هدایت درخواست‌ها به API مناسب
- پیکربندی HTTPS با Let's Encrypt برای ارتباطات امن
- تنظیم فشرده‌سازی و کش‌گذاری برای بهبود عملکرد

### ج. امنیت و نگه‌داری

#### امنیت
- پیکربندی SSL/TLS با گواهی‌نامه‌های معتبر
- تنظیم سیاست‌های CORS برای کنترل دسترسی
- محافظت در برابر حملات رایج وب (XSS، CSRF، SQL Injection)

#### مانیتورینگ و لاگ‌گیری
- استفاده از journalctl برای مدیریت لاگ‌های سیستم
- پیکربندی logrotate برای چرخش و آرشیو لاگ‌ها
- استفاده از htop و سایر ابزارها برای نظارت بر منابع سیستم
- پیکربندی هشدارها برای اطلاع از مشکلات احتمالی

## سرویس‌های خارج از VPS

برخی بخش‌های پروژه خارج از VPS اصلی میزبانی می‌شوند:

### 1. فرانت‌اند (Next.js)
- میزبانی روی پلتفرم Vercel
- بهره‌مندی از CDN جهانی برای تحویل سریع محتوا
- استفاده از Server-Side Rendering برای بهینه‌سازی SEO

### 2. مدیریت محتوا (AppFlowy)
- اجرا روی سیستم‌های دسکتاپ تیم تولید محتوا
- همگام‌سازی با مخزن گیت‌هاب برای مدیریت نسخه‌ها
- تولید محتوا در فرمت مارک‌داون برای استفاده در سایت

### 3. پایگاه داده (Supabase)
- استفاده از PostgreSQL به عنوان پایگاه داده اصلی
- بهره‌گیری از سیستم احراز هویت Supabase
- استفاده از قابلیت‌های ذخیره‌سازی فایل برای مدیریت رسانه‌ها

### 4. سیستم RAG و هوش مصنوعی
- استفاده از OpenAI API برای تولید محتوا و پاسخگویی به سؤالات
- ذخیره وکتورها در پایگاه داده وکتور (مانند Pinecone یا Supabase pgvector)
- پردازش و آماده‌سازی داده برای سیستم RAG در محیط ابری

## جریان داده و ارتباطات

```mermaid
graph TD
    A[کاربر] -->|درخواست صفحه| B[Next.js/Vercel]
    B -->|API Calls| C[Rust API/VPS]
    C -->|ذخیره/بازیابی داده| D[Supabase]
    B -->|سؤالات کاربر| E[سیستم RAG]
    E -->|جستجوی وکتور| F[پایگاه داده وکتور]
    E -->|تولید پاسخ| G[OpenAI API]
    H[تیم تولید محتوا] -->|تولید محتوا| I[AppFlowy]
    I -->|انتشار محتوا| J[GitHub]
    J -->|CI/CD| B
مسیر توسعه آینده
در فازهای بعدی توسعه، موارد زیر به معماری اضافه خواهند شد:
سیستم وکتور DB اختصاصی برای کاهش وابستگی به سرویس‌های خارجی
زیرساخت برگزاری آزمون آنلاین با قابلیت تصحیح خودکار و ارائه کارنامه
سیستم کش توزیع‌شده برای بهبود عملکرد و پاسخگویی
زیرساخت PWA برای دسترسی آفلاین به محتوا
سیستم مانیتورینگ پیشرفته برای نظارت بر عملکرد و شناسایی خودکار مشکلات

# معماری فنی پروژه کوشک کنکور هنر

این مستند معماری فنی، پشته فناوری و ساختار پروژه کوشک کنکور هنر را توضیح می‌دهد. همچنین گام‌های اجرایی برای پیاده‌سازی و استقرار پروژه را شرح می‌دهد.

## معماری کلی

پروژه کوشک کنکور هنر از یک معماری Monorepo ماژولار استفاده می‌کند که شامل چندین زیرسیستم مستقل اما منسجم است. این معماری امکان توسعه موازی، اشتراک‌گذاری کد و مدیریت یکپارچه را فراهم می‌کند.

### نمودار معماری

```mermaid
graph TD
    Client[کاربر] -->|درخواست| Frontend[Next.js Frontend]
    Frontend -->|API Call| Backend[Rust API]
    Backend -->|داده| Database[(Supabase/PostgreSQL)]
    Editor[AppFlowy] -->|تولید محتوا| Database
    Frontend -->|احراز هویت| Auth[Supabase Auth]
    Backend -->|احراز هویت| Auth
ماژول‌های اصلی
1. ماژول احراز هویت (Authentication)
استفاده از سرویس احراز هویت Supabase
پشتیبانی از ورود/ثبت‌نام با ایمیل و رمز عبور
قابلیت افزودن OAuth در آینده
پیاده‌سازی کلاینت Supabase در فرانت‌اند (Next.js) و بک‌اند (Rust)
2. ماژول پروفایل کاربر (User Profile)
توابع CRUD برای مدیریت اطلاعات کاربری
ذخیره‌سازی داده‌ها در PostgreSQL/Supabase
طراحی جدول profiles در Supabase با فیلدهای مورد نیاز
مدیریت ترجیحات و تنظیمات کاربران
3. ماژول بلاگ (Blog)
مدیریت دسته‌بندی‌ها و پست‌ها
رابط کاربری Next.js با SSG/SSR برای بهینه‌سازی SEO
API در Rust برای عملیات سطح پایین
فیلدهای مهم: عنوان، توضیحات متا، وضعیت (قفل/منتشر)، متن "به‌زودی"
4. ماژول مدیریت محتوا (Content Management)
استفاده از AppFlowy به عنوان ابزار ویرایش محتوا
مدیریت متن‌ها و ساختار صفحات
یکپارچه‌سازی با Supabase برای ذخیره‌سازی داده‌ها
قابلیت self-host کردن AppFlowy با پروژه Supabase
5. ماژول فضای کاری (Workspace)
محیط کاری کاربر برای مشاهده پیشرفت و امتیازات
رابط کاربری اختصاصی در Next.js
سیستم گیمیفیکیشن برای افزایش تعامل کاربران
داشبورد شخصی‌سازی شده
6. ماژول نقش‌ها (Roles)
تعریف سطوح دسترسی (کاربر عادی، مدیر، ویرایشگر)
استفاده از Row Level Security در Postgres/Supabase
کنترل دسترسی‌ها براساس نقش‌ها
مدیریت مجوزها برای هر نقش
پشته فناوری (Tech Stack)
فرانت‌اند
فریم‌ورک: Next.js (React)
دلایل انتخاب:
پشتیبانی از SSR/SSG برای بهینه‌سازی SEO
عملکرد بهتر نسبت به Flutter Web در زمینه SEO
اکوسیستم غنی و پشتیبانی گسترده
راه‌اندازی: npx create-next-app@latest --example with-jest
کتابخانه‌های کلیدی:
React Query برای مدیریت state
Tailwind CSS برای استایل‌دهی
i18n برای پشتیبانی چندزبانه
بک‌اند
زبان و فریم‌ورک: Rust با Axum یا Actix-Web
دلایل انتخاب:
امنیت و کارایی بالا
مدیریت حافظه ایمن
عملکرد سریع
API: توابع RESTful برای مدیریت بلاگ، کاربران و گیمیفیکیشن
یکپارچه‌سازی: استفاده از افزونه @monodon/rust در Nx
مدیریت محتوا
ابزار: AppFlowy
فرمت محتوا: Markdown
ذخیره‌سازی: یکپارچه‌سازی با Supabase
قابلیت‌ها: ویرایش صفحات، مدیریت دسته‌بندی‌ها، پیش‌نمایش محتوا
پایگاه داده
سرویس: Supabase (PostgreSQL)
مدل داده:
جداول کاربران، پروفایل‌ها، دسته‌بندی‌ها و پست‌ها
روابط بین جداول
Row Level Security برای کنترل دسترسی
قابلیت‌ها: دسترسی کامل به PostgreSQL، داشبورد مدیریت، سیستم احراز هویت
کانتینر و استقرار
محلی: Docker Compose با Colima (جایگزین Docker Desktop برای macOS)
سرویس‌ها:
Next.js
Rust API
AppFlowy (self-hosted)
Postgres/Supabase
متغیرهای محیطی: URL و کلید‌های Supabase، تنظیمات پیکربندی
تست و دیباگ
فرانت‌اند: Jest و React Testing Library
بک‌اند: cargo test در Rust
مدیریت تست: Nx و پلاگین @nx/jest برای اجرای موازی تست‌ها
ساختار: پوشه تست جداگانه در هر ماژول
مدیریت Monorepo
برای مدیریت Monorepo و هماهنگی ماژول‌ها، از Yarn Workspaces یا Nx استفاده می‌شود:
مزایا:
تمام تنظیمات تست و CI/CD در یک محل مشترک
انتشار و به‌روزرسانی ساده‌تر بسته‌ها
امکان اعمال تغییرات سرتاسری با یک کامیت atomic
اشتراک‌گذاری کد بین ماژول‌ها
ساختار پوشه‌ها:
plaintext

Hide
/
├── apps/
│   ├── web/          # پروژه Next.js
│   └── api/          # پروژه Rust
├── packages/
│   ├── ui/           # کامپوننت‌های مشترک
│   ├── utils/        # توابع کمکی
│   └── config/       # تنظیمات مشترک
├── tools/
│   └── scripts/      # اسکریپت‌های ابزاری
├── docker/
│   └── docker-compose.yml
├── nx.json           # یا
├── package.json      # با تنظیمات workspaces
└── README.md
گام‌های پیاده‌سازی MVP
1. ایجاد Monorepo
راه‌اندازی با Nx یا Yarn Workspaces
ایجاد ساختار پوشه‌ها
تنظیم اشتراک‌گذاری کد بین ماژول‌ها
bash

Hide
# با Nx
npx create-nx-workspace koushk-konkur --preset=empty

# یا با Yarn Workspaces
mkdir koushk-konkur
cd koushk-konkur
yarn init -y
2. راه‌اندازی Next.js
ایجاد پروژه با پیکربندی Jest
تنظیم Router و صفحات داینامیک
پیکربندی SEO
bash

Hide
# در Nx
nx g @nx/next:app web

# یا مستقیم
npx create-next-app@latest apps/web --example with-jest
3. پیاده‌سازی API در Rust
ایجاد پروژه Rust در پوشه مجزا
تنظیم Actix-Web یا Axum
ایجاد API‌های REST برای دسته‌بندی‌ها و پست‌ها
bash

Hide
# در پوشه apps/api
cargo init --bin
# افزودن وابستگی‌ها به Cargo.toml
4. راه‌اندازی Supabase
ایجاد پروژه در داشبورد Supabase
طراحی و ایجاد جداول مورد نیاز:
جدول پروفایل‌ها
جدول دسته‌بندی‌ها
جدول پست‌ها
فعال‌سازی احراز هویت و تنظیم RLS
5. پیکربندی AppFlowy
راه‌اندازی AppFlowy به صورت self-host
اتصال به دیتابیس Supabase
ایجاد صفحات پیش‌نویس بلاگ
6. تنظیم Docker Compose
ایجاد فایل docker-compose.yml برای سرویس‌های اصلی
تنظیم شبکه، ولوم‌ها و متغیرهای محیطی
yaml

Hide
version: '3'
services:
  web:
    build:
      context: ./apps/web
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_SUPABASE_URL=http://supabase:8000
      - NEXT_PUBLIC_SUPABASE_KEY=your-key

  api:
    build:
      context: ./apps/api
    ports:
      - "8080:8080"
    environment:
      - DATABASE_URL=postgres://postgres:postgres@supabase:5432/postgres

  supabase:
    image: supabase/supabase-local
    ports:
      - "8000:8000"
    volumes:
      - supabase-data:/var/lib/postgresql/data

volumes:
  supabase-data:
7. ورود داده‌های اولیه
ایجاد اسکریپت Seed برای دسته‌بندی‌ها و پست‌های اولیه
sql

Hide
-- supabase/seed.sql
INSERT INTO categories (id, name) VALUES (1, 'تاریخ هنر'), (2, 'نقاشی');
INSERT INTO posts (id, title, category_id, status, content) VALUES 
  (1, 'نقاشی کلاسیک', 2, 'locked', 'به‌زودی...'),
  (2, 'دوره رنسانس', 1, 'locked', 'به‌زودی...');
8. پیاده‌سازی تست‌ها
تنظیم Jest در Next.js
نوشتن تست‌های واحد برای کامپوننت‌ها
پیاده‌سازی تست‌ها در Rust با #[cfg(test)]
9. تست و رفع اشکالات
اجرای محلی با Docker Compose
تست عملیات ورود/خروج کاربران
تست نمایش محتوای قفل‌شده
بررسی ناوبری و تعاملات کاربری
استقرار در محیط تولید
استقرار در VPS پارس‌پک
برای محیط تولید در ایران، استفاده از سرور مجازی لینوکس پارس‌پک پیشنهاد می‌شود:
مشخصات پیشنهادی:
2 CPU
4GB RAM
25-50 گیگابایت SSD
هزینه تقریبی: 5-15 دلار در ماه
مزایا:
دسترسی root برای نصب ابزارهای توسعه
تأخیر شبکه کمتر برای کاربران ایرانی
پشتیبانی از Docker و سایر ابزارهای مورد نیاز
نکات مهم:
اطمینان از آی‌پی ثابت (به خصوص برای دامنه‌های .ir)
فعال‌سازی پشتیبان‌گیری خودکار
تنظیم فایروال (حداقل برای پورت SSH/22)
گام‌های استقرار
آماده‌سازی سرور:
نصب سیستم‌عامل (Ubuntu 22.04 LTS)
نصب Docker و Docker Compose
پیکربندی فایروال و امنیت
استقرار کد:
کلون مخزن گیت روی سرور
ساخت فایل‌های .env با تنظیمات مناسب
اجرای docker-compose up -d
تنظیم دامنه و SSL:
پیکربندی DNS برای دامنه
نصب و پیکربندی Let's Encrypt
تنظیم Nginx یا Caddy برای پراکسی معکوس
مانیتورینگ و لاگینگ:
پیکربندی سیستم لاگ
تنظیم هشدارها برای مشکلات احتمالی
پیکربندی پشتیبان‌گیری خودکار
چک‌لیست گام‌به‌گام شروع پروژه
ایجاد Monorepo
 راه‌اندازی با Nx یا Yarn Workspaces
 ایجاد ساختار پوشه‌ها
 تنظیم اشتراک‌گذاری کد
تنظیم ماژول احراز هویت
 پیکربندی Supabase Auth
 ایجاد صفحات ورود/ثبت‌نام در Next.js
 پیاده‌سازی کلاینت Supabase در فرانت‌اند و بک‌اند
ساخت ماژول بلاگ
 طراحی مدل داده برای دسته‌بندی‌ها و پست‌ها
 ایجاد صفحات داینامیک در Next.js
 پیاده‌سازی API در Rust
ایجاد جداول در Supabase
 طراحی و ایجاد جدول پروفایل‌ها
 طراحی و ایجاد جدول دسته‌بندی‌ها
 طراحی و ایجاد جدول پست‌ها
 تنظیم روابط بین جداول
راه‌اندازی AppFlowy
 نصب و پیکربندی AppFlowy
 اتصال به دیتابیس Supabase
 ایجاد قالب‌های محتوا
پیاده‌سازی Docker
 ایجاد Dockerfile برای هر سرویس
 نوشتن فایل docker-compose.yml
 تست اجرای محلی
نوشتن تست‌ها
 پیکربندی Jest برای فرانت‌اند
 نوشتن تست‌های واحد
 پیاده‌سازی تست‌های Rust
ورود داده‌های اولیه
 نوشتن اسکریپت‌های Seed
 ایجاد دسته‌بندی‌ها و پست‌های قفل‌شده
 تست نمایش داده‌ها
تست عملکردها
 تست نمایش پست‌های قفل‌شده
 تست ورود/خروج کاربران
 تست ناوبری و تعاملات کاربری
استقرار
 راه‌اندازی VPS
 نصب و پیکربندی Docker
 استقرار کد و اجرای سرویس‌ها
 تنظیم دامنه و SSL
plaintext

Hide

**نکات بازنویسی**:

1. محتوا را به بخش‌های منطقی و ساختاریافته تقسیم کردم
2. یک نمودار معماری با mermaid اضافه کردم تا ارتباط بین اجزای سیستم به صورت بصری نمایش داده شود
3. ماژول‌های اصلی را با جزئیات بیشتری توضیح دادم
4. پشته فناوری را به بخش‌های مجزا تقسیم کردم و برای هر بخش توضیحات تکمیلی ارائه دادم
5. گام‌های پیاده‌سازی MVP را با دستورات و مثال‌های عملی تکمیل کردم
6. بخش استقرار در محیط تولید را با جزئیات بیشتری شرح دادم
7. یک چک‌لیست گام‌به‌گام برای شروع پروژه اضافه کردم
8. زبان فنی و تخصصی را حفظ کردم اما ساختار جملات را برای خوانایی بهتر بهبود دادم

این مستند در بخش "technical/architecture.md" قرار می‌گیرد، زیرا به جزئیات معماری فنی و پشته فناوری پروژه می‌پردازد.

Add Attachment
Continue chatting with Highlight...


